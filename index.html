<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shroudfall Dice Roller – Choose Dice Colors</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0; padding: 1em;
    text-align: center;
  }
  #diceColorSelectors {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 1.5em;
  }
  .dice-select-wrapper {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  select {
    font-size: 1em;
    padding: 0.3em 0.6em;
    border-radius: 4px;
    border: 1px solid #ccc;
    min-width: 90px;
    color: #000;
    appearance: none;
    background-color: white;
    cursor: pointer;
  }
  .color-indicator {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #999;
  }
  /* Colors for indicators */
  .grey { background-color: #888; }
  .yellow { background-color: #f1c40f; }
  .red { background-color: #e74c3c; }
  .none { background-color: transparent; border: 1px dashed #bbb;}
  .dice-container {
    display: inline-flex;
    align-items: center;
    margin: 4px;
    vertical-align: middle;
  }
  img.dice-img {
    width: 48px;
    height: 48px;
    margin-right: 6px;
    vertical-align: middle;
  }
  .step-header {
    font-weight: bold;
    margin-bottom: 0.5em;
  }
  .buttons {
    margin: 1em 0;
    font-size: 1.1em;
  }
  button {
    font-size: 1em;
    padding: 0.4em 1em;
    margin: 0.2em;
    cursor: pointer;
  }
  input[type="checkbox"] {
    margin-left: 6px;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>Shroudfall Dice Roller – Choose Dice Colors</h1>

<div id="diceColorSelectors">
  <div class="dice-select-wrapper">
    <div class="color-indicator" id="color-indicator-0"></div>
    <select id="die0" onchange="updateColorIndicator(0)">
      <option value="grey">Grey</option>
      <option value="yellow">Yellow</option>
      <option value="red">Red</option>
    </select>
  </div>
  <div class="dice-select-wrapper">
    <div class="color-indicator" id="color-indicator-1"></div>
    <select id="die1" onchange="updateColorIndicator(1)">
      <option value="grey">Grey</option>
      <option value="yellow">Yellow</option>
      <option value="red">Red</option>
    </select>
  </div>
  <div class="dice-select-wrapper">
    <div class="color-indicator" id="color-indicator-2"></div>
    <select id="die2" onchange="updateColorIndicator(2)">
      <option value="grey">Grey</option>
      <option value="yellow">Yellow</option>
      <option value="red">Red</option>
    </select>
  </div>
  <div class="dice-select-wrapper">
    <div class="color-indicator" id="color-indicator-3"></div>
    <select id="die3" onchange="updateColorIndicator(3)">
      <option value="grey">Grey</option>
      <option value="yellow">Yellow</option>
      <option value="red">Red</option>
    </select>
  </div>
  <div class="dice-select-wrapper">
    <div class="color-indicator" id="color-indicator-4"></div>
    <select id="die4" onchange="updateColorIndicator(4)">
      <option value="none">None</option>
      <option value="grey">Grey</option>
      <option value="yellow">Yellow</option>
      <option value="red">Red</option>
    </select>
  </div>
</div>

<div class="buttons">
  <button id="btnRoll" onclick="initialRoll()">Roll All Dice</button>
  <button id="btnEssenceReroll" onclick="essenceReroll()" style="display:none;">Essence Reroll (all dice)</button>
  <button id="btnActiveReroll" onclick="activePlayerReroll()" style="display:none;">Active Player: Reroll Selected</button>
  <button id="btnInactiveReroll" onclick="inactivePlayerReroll()" style="display:none;">Inactive Player: Reroll Selected</button>
  <button id="btnShowFinal" onclick="showFinal()" style="display:none;">Show Final Result</button>
  <button id="btnReset" onclick="resetAll()" style="display:none;">Reset</button>
</div>

<div class="results" id="results"></div>

<script>
  const greyDie = [null, null, 1, 1, 2, 2];
  const yellowDie = [0, 1, 2, 2, 3, 3];
  const redDie    = [2, 2, 3, 3, 4, 4];

  let currentRolls = [];
  let nextDieId = 0;
  let step = 1;

  const btnRoll = document.getElementById('btnRoll');
  const btnEssence = document.getElementById('btnEssenceReroll');
  const btnActiveReroll = document.getElementById('btnActiveReroll');
  const btnInactiveReroll = document.getElementById('btnInactiveReroll');
  const btnShowFinal = document.getElementById('btnShowFinal');
  const btnReset = document.getElementById('btnReset');

  function rollDie(color) {
    let dieArray;
    if(color === 'grey') dieArray = greyDie;
    else if(color === 'yellow') dieArray = yellowDie;
    else if(color === 'red') dieArray = redDie;
    else return null;

    let side;
    do {
      side = dieArray[Math.floor(Math.random() * dieArray.length)];
    } while (side === null);

    return side;
  }

  function initialRoll() {
    currentRolls = [];
    nextDieId = 0;

    for(let i=0; i<5; i++){
      const sel = document.getElementById(`die${i}`);
      const color = sel.value;
      if(color === 'none') continue;
      const val = rollDie(color);
      currentRolls.push({color, value: val, id: nextDieId++});
    }

    document.getElementById('diceColorSelectors').style.display = 'none';
    btnRoll.style.display = 'none';

    step = 2;
    btnEssence.style.display = 'inline-block';
    btnActiveReroll.style.display = 'inline-block';

    updateResults("Step 1: Initial Roll");
  }

  function essenceReroll() {
    if(step !== 2) return;
    for(let i=0; i<currentRolls.length; i++){
      currentRolls[i].value = rollDie(currentRolls[i].color);
    }
    step = 3;
    btnEssence.style.display = 'none';
    btnActiveReroll.style.display = 'inline-block';
    updateResults("Step 2: Essence Reroll (all dice)");
  }

  function activePlayerReroll(){
    if(step !== 2 && step !== 3) return;

    let anyRerolled = false;
    currentRolls.forEach((die) => {
      const checkbox = document.getElementById('active_reroll_chk_' + die.id);
      if(checkbox && checkbox.checked){
        die.value = rollDie(die.color);
        anyRerolled = true;
      }
    });
    step = 3;
    btnEssence.style.display = 'none';
    if(anyRerolled){
      updateResults("Step 3: Active Player Reroll");
    } else {
      updateResults("Step 3: No Active Player Reroll");
    }
    btnActiveReroll.style.display = 'none';
    btnInactiveReroll.style.display = 'inline-block';
  }

  function inactivePlayerReroll(){
    if(step !== 3) return;
    let anyRerolled = false;
    currentRolls.forEach((die) => {
      const checkbox = document.getElementById('inactive_reroll_chk_' + die.id);
      if(checkbox && checkbox.checked){
        die.value = rollDie(die.color);
        anyRerolled = true;
      }
    });
    if(anyRerolled){
      updateResults("Step 4: Inactive Player Reroll");
    } else {
      updateResults("Step 4: No Inactive Player Reroll");
    }
    step = 4;
    btnInactiveReroll.style.display = 'none';
    btnShowFinal.style.display = 'inline-block';
  }

  function showFinal() {
    if(step !== 4) return;
    updateResults("Final Result");
    btnShowFinal.style.display = 'none';
    btnReset.style.display = 'inline-block';
  }

  function resetAll() {
    currentRolls = [];
    nextDieId = 0;
    step = 1;

    document.getElementById('diceColorSelectors').style.display = 'flex';
    btnRoll.style.display = 'inline-block';
    btnEssence.style.display = 'none';
    btnActiveReroll.style.display = 'none';
    btnInactiveReroll.style.display = 'none';
    btnShowFinal.style.display = 'none';
    btnReset.style.display = 'none';
    updateResults('');
  }

  function updateResults(headerText) {
    const container = document.getElementById('results');
    container.innerHTML = '';
    if(headerText) {
      const h = document.createElement('h2');
      h.className = 'step-header';
      h.textContent = headerText;
      container.appendChild(h);
    }

    currentRolls.forEach((die) => {
      const dieDiv = document.createElement('div');
      dieDiv.className = 'dice-container';

      // Dice image
      const img = document.createElement('img');
      img.className = 'dice-img';
      img.src = `images/${die.color}_${die.value}.png`;
      img.alt = `${die.color} die showing ${die.value}`;
      dieDiv.appendChild(img);

      // Text info
      const textSpan = document.createElement('span');
      textSpan.textContent = `${die.color.charAt(0).toUpperCase() + die.color.slice(1)} Die: ${die.value}`;
      dieDiv.appendChild(textSpan);

      // Add reroll checkbox depending on step
      if(step === 2 || step === 3) {
        if(btnInactiveReroll.style.display === 'inline-block') {
          // Inactive player's reroll
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.id = `inactive_reroll_chk_${die.id}`;
          chk.title = "Select this die to reroll (Inactive Player)";
          dieDiv.appendChild(chk);
        } else {
          // Active player's reroll
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.id = `active_reroll_chk_${die.id}`;
          chk.title = "Select this die to reroll (Active Player)";
          dieDiv.appendChild(chk);
        }
      }

      container.appendChild(dieDiv);
    });
  }

  function updateColorIndicator(index) {
    const select = document.getElementById(`die${index}`);
    const color = select.value;
    const indicator = document.getElementById(`color-indicator-${index}`);

    // Set class for indicator
    indicator.className = 'color-indicator ' + color;

    // Set background color and text color of select to match the color
    switch(color){
      case 'grey':
        select.style.backgroundColor = '#888';
        select.style.color = '#fff';
        break;
      case 'yellow':
        select.style.backgroundColor = '#f1c40f';
        select.style.color = '#000';
        break;
      case 'red':
        select.style.backgroundColor = '#e74c3c';
        select.style.color = '#fff';
        break;
      case 'none':
      default:
        select.style.backgroundColor = 'white';
        select.style.color = '#000';
        break;
    }
  }

  window.onload = () => {
    for(let i=0; i<5; i++) {
      updateColorIndicator(i);
    }
  };
</script>

</body>
</html>
