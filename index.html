<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shroudfall Dice Roller – Full Flow with Inactive Player</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0; padding: 1em;
    text-align: center;
  }
  .dice-row, .controls, .buttons {
    margin: 1em 0;
    font-size: 1.1em;
  }
  select, button {
    font-size: 1em;
    padding: 0.4em 1em;
    margin: 0.2em;
  }
  .results {
    margin-top: 2em;
    font-size: 1.1em;
    text-align: left;
    display: inline-block;
    background: #fff;
    padding: 1em;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
  }
  .dice-container {
    display: inline-flex;
    align-items: center;
    margin: 4px;
    vertical-align: middle;
  }
  img.dice-img {
    width: 48px;
    height: 48px;
    margin-right: 6px;
    vertical-align: middle;
  }
  label {
    user-select: none;
  }
  .step-header {
    font-weight: bold;
    margin-bottom: 0.5em;
  }
</style>
</head>
<body>

<h1>Shroudfall Dice Roller – Full Flow with Inactive Player</h1>

<div class="controls">
  <label for="numDice">Number of dice (4 or 5): </label>
  <select id="numDice" disabled>
    <option value="4">4</option>
    <option value="5">5 (with infusion)</option>
  </select>
</div>

<div class="buttons">
  <button id="btnRoll" onclick="initialRoll()">Roll All Dice</button>
  <button id="btnEssenceReroll" onclick="essenceReroll()" style="display:none;">Essence Reroll (all dice)</button>
  <button id="btnActiveReroll" onclick="activePlayerReroll()" style="display:none;">Active Player: Reroll Selected</button>
  <button id="btnInactiveReroll" onclick="inactivePlayerReroll()" style="display:none;">Inactive Player: Reroll Selected</button>
  <button id="btnShowFinal" onclick="showFinal()" style="display:none;">Show Final Result</button>
  <button id="btnReset" onclick="resetAll()" style="display:none;">Reset</button>
</div>

<div class="results" id="results"></div>

<script>
  const yellowDie = [0, 1, 2, 2, 3, 3];
  const redDie    = [2, 2, 3, 3, 4, 4];

  let currentRolls = [];      // {color, value, id}
  let rerolledFlags = [];     // mark dice already rerolled by active or inactive player
  let nextDieId = 0;

  // Keep track of rerolls by who
  let activePlayerRerolled = [];
  let inactivePlayerRerolled = [];

  // State step: 1=initial roll, 2=essence reroll, 3=active reroll, 4=inactive reroll, 5=final
  let step = 1;

  const numDiceSelect = document.getElementById('numDice');
  const btnRoll = document.getElementById('btnRoll');
  const btnEssence = document.getElementById('btnEssenceReroll');
  const btnActiveReroll = document.getElementById('btnActiveReroll');
  const btnInactiveReroll = document.getElementById('btnInactiveReroll');
  const btnShowFinal = document.getElementById('btnShowFinal');
  const btnReset = document.getElementById('btnReset');

  function rollDie(color) {
    const dieArray = (color === 'yellow') ? yellowDie : redDie;
    return dieArray[Math.floor(Math.random() * dieArray.length)];
  }

  function initialRoll() {
    const num = parseInt(numDiceSelect.value);
    currentRolls = [];
    rerolledFlags = [];
    activePlayerRerolled = [];
    inactivePlayerRerolled = [];
    nextDieId = 0;

    numDiceSelect.disabled = true;
    btnRoll.style.display = 'none';

    for(let i=0; i<num; i++){
      const color = (i%2===0) ? 'yellow' : 'red';
      const val = rollDie(color);
      currentRolls.push({color, value: val, id: nextDieId++});
      rerolledFlags.push(false);
    }
    step = 2;
    btnEssence.style.display = 'inline-block';
    btnActiveReroll.style.display = 'inline-block';
    updateResults("Step 1: Initial Roll");
  }

  function essenceReroll() {
    if(step !== 2) return;
    for(let i=0; i<currentRolls.length; i++){
      currentRolls[i].value = rollDie(currentRolls[i].color);
      rerolledFlags[i] = true;
      activePlayerRerolled[i] = true;
    }
    step = 3;
    btnEssence.style.display = 'none';
    updateResults("Step 2: Essence Reroll (all dice)");
  }

  function activePlayerReroll(){
    if(step !== 2 && step !== 3) return;

    let anyRerolled = false;
    currentRolls.forEach((die, i) => {
      const checkbox = document.getElementById('active_reroll_chk_' + die.id);
      if(checkbox && checkbox.checked && !rerolledFlags[i]){
        currentRolls[i].value = rollDie(currentRolls[i].color);
        rerolledFlags[i] = true;
        activePlayerRerolled[i] = true;
        anyRerolled = true;
      }
    });
    if(anyRerolled){
      step = 3;
      btnEssence.style.display = 'none';
      updateResults("Step 3: Active Player Reroll");
      // after active rerolls, let inactive player reroll
      btnActiveReroll.style.display = 'none';
      btnInactiveReroll.style.display = 'inline-block';
    } else {
      alert("Select at least one die to reroll or skip.");
    }
  }

  function inactivePlayerReroll(){
    if(step !== 3) return;
    let anyRerolled = false;
    currentRolls.forEach((die, i) => {
      const checkbox = document.getElementById('inactive_reroll_chk_' + die.id);
      if(checkbox && checkbox.checked && !rerolledFlags[i]){
        currentRolls[i].value = rollDie(currentRolls[i].color);
        rerolledFlags[i] = true;
        inactivePlayerRerolled[i] = true;
        anyRerolled = true;
      }
    });
    step = 4;
    btnInactiveReroll.style.display = 'none';
    btnShowFinal.style.display = 'inline-block';
    if(anyRerolled){
      updateResults("Step 4: Inactive Player Reroll");
    } else {
      updateResults("Step 4: Inactive Player chose no rerolls");
    }
  }

  function showFinal(){
    if(step !== 4) return;
    step = 5;
    btnShowFinal.style.display = 'none';
    btnReset.style.display = 'inline-block';
    updateResults("Step 5: Final Result");
  }

  function resetAll(){
    step = 1;
    currentRolls = [];
    rerolledFlags = [];
    activePlayerRerolled = [];
    inactivePlayerRerolled = [];
    nextDieId = 0;

    numDiceSelect.disabled = false;
    btnRoll.style.display = 'inline-block';
    btnEssence.style.display = 'none';
    btnActiveReroll.style.display = 'none';
    btnInactiveReroll.style.display = 'none';
    btnShowFinal.style.display = 'none';
    btnReset.style.display = 'none';

    document.getElementById('results').innerHTML = '';
  }

  function updateResults(headerText){
    const container = document.getElementById('results');
    container.innerHTML = '';
    const h = document.createElement('div');
    h.className = 'step-header';
    h.textContent = headerText;
    container.appendChild(h);

    currentRolls.forEach((die,i) => {
      const span = document.createElement('span');
      span.className = 'dice-container';

      const img = document.createElement('img');
      img.src = `images/${die.color}_${die.value}.png`;
      img.alt = die.value;
      img.className = 'dice-img';
      span.appendChild(img);

      if(step === 2 || step === 3){
        if(!rerolledFlags[i]){
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.id = `active_reroll_chk_${die.id}`;
          span.appendChild(chk);
          const lbl = document.createElement('label');
          lbl.htmlFor = chk.id;
          lbl.textContent = ' Active reroll';
          span.appendChild(lbl);
        } else {
          const p = document.createElement('span');
          p.textContent = ' (Already rerolled)';
          span.appendChild(p);
        }
      } else if(step === 4){
        if(!rerolledFlags[i]){
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.id = `inactive_reroll_chk_${die.id}`;
          span.appendChild(chk);
          const lbl = document.createElement('label');
          lbl.htmlFor = chk.id;
          lbl.textContent = ' Inactive reroll';
          span.appendChild(lbl);
        } else {
          const p = document.createElement('span');
          p.textContent = ' (Already rerolled)';
          span.appendChild(p);
        }
      } else {
        // step 1 or 5 (initial or final) – no checkboxes
        let txt = '';
        if(activePlayerRerolled[i]) txt += 'Active rerolled. ';
        if(inactivePlayerRerolled[i]) txt += 'Inactive rerolled.';
        if(txt !== ''){
          const p = document.createElement('span');
          p.textContent = `(${txt.trim()})`;
          span.appendChild(p);
        }
      }

      container.appendChild(span);
    });

    const total = currentRolls.reduce((acc, die) => acc + die.value, 0);
    const tot = document.createElement('div');
    tot.style.marginTop = '1em';
    tot.innerHTML = `<strong>Total:</strong> ${total}`;
    container.appendChild(tot);
  }

  // Initialize: only roll button enabled
  resetAll();

</script>

</body>
</html>
